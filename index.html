<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

    <title>Memory &amp; Caches</title>

    <link rel="stylesheet" href="reveal.js/css/reveal.css">
    <link rel="stylesheet" href="reveal.js/css/theme/league.css">

    <!-- Theme used for syntax highlighting of code -->
    <link rel="stylesheet" href="reveal.js/lib/css/zenburn.css">

    <style>
        .reveal .slides section .fragment.highlight-current-code {
            opacity: 1;
            visibility: inherit;
        }

        .reveal .slides section .fragment.highlight-current-code.current-fragment {
            background: #555a5f;
            color: #ffffff;
        }

        div.attribution {
            margin-top: 1em;
            font-size: smaller;
            font-style: italic;
        }

        .no-border {
            background: none !important;
            border: none !important;
            box-shadow: none !important;
        }

        rect.hl {
            fill: #ff2c2d;
            fill-opacity: 0.35;
            stroke: #ff2c2d;
            stroke-width: 5px;
        }

    </style>

    <!-- Printing and PDF exports -->
    <script>
        var link = document.createElement('link');
        link.rel = 'stylesheet';
        link.type = 'text/css';
        link.href = window.location.search.match(/print-pdf/gi) ? 'reveal.js/css/print/pdf.css' : 'reveal.js/css/print/paper.css';
        document.getElementsByTagName('head')[0].appendChild(link);
    </script>
</head>
<body>
<div class="reveal">
    <svg>
        <defs>
            <marker id='head' orient="auto" markerWidth='2' markerHeight='4' refX='0.1' refY='2'>
                <path d='M0,0 V4 L2,2 Z' fill="red"/>
            </marker>
        </defs>
    </svg>
    <div class="slides">
        <section>
            <h2>Memory &amp; Caches</h2>
            <img src="core-memory.jpeg" height="200px">
            <h3>How they work, and how they affect performance</h3>
            <h5>Matt Godbolt <a href="https://twitter.com/mattgodbolt">@mattgodbolt</a></h5>

        </section>
        <section>
            <h2>Outline</h2>
            <ul>
                <li>Physical memory</li>
                <li>Caches</li>
                <li>Measuring</li>
                <li>Virtual memory</li>
                <li>Multiprocessing</li>
            </ul>
        </section>
        <section
                data-background-image="RAM-sheep.png"
                data-background-size="200px"
                data-background-position="bottom right">
            <h2>Types of RAM</h2>
            <ul>
                <li>Static RAM</li>
                <li>Dynamic RAM</li>
                <li>Non-volatile</li>
            </ul>
        </section>
        <section>
            <section>
                <h2>1 Bit of Static RAM</h2>
                <svg width="500" height="400" xmlns="http://www.w3.org/2000/svg">
                    <image href="cache-ram.png" height="100%" width="100%"/>
                    <rect class="fragment current-visible hl"
                          data-fragment-index="1"
                          x="20%" y="12%"
                          rx="10px" ry="10px"
                          width="60%" height="85%"/>
                    <rect class="fragment hl"
                          data-fragment-index="2"
                          x="40%" y="0%"
                          rx="10px" ry="10px"
                          width="20%" height="15%"/>
                    <rect class="fragment hl"
                          data-fragment-index="3"
                          x="8%" y="35%"
                          rx="10px" ry="10px"
                          width="20%" height="15%"/>
                    <rect class="fragment hl"
                          data-fragment-index="3"
                          x="73%" y="35%"
                          rx="10px" ry="10px"
                          width="20%" height="18%"/>
                    <path class="fragment"
                          data-fragment-index="4"
                          marker-end='url(#head)'
                          stroke-width='5'
                          fill='none' stroke='red'
                          d="M115 250 l-50 0 l0 100"
                    />
                    <path class="fragment"
                          data-fragment-index="4"
                          marker-end='url(#head)'
                          stroke-width='5'
                          fill='none' stroke='red'
                          d="M380 250 l50 0 l0 100"
                    />
                </svg>
            </section>
            <section>
                <h2>1 Bit of Static RAM</h2>
                <svg width="500" height="400" xmlns="http://www.w3.org/2000/svg">
                    <image href="cache-ram.png" height="100%" width="100%"/>
                    <rect class="fragment hl"
                          data-fragment-index="1"
                          x="40%" y="0%"
                          rx="10px" ry="10px"
                          width="20%" height="15%"/>
                    <rect class="fragment hl"
                          data-fragment-index="2"
                          x="8%" y="35%"
                          rx="10px" ry="10px"
                          width="20%" height="15%"/>
                    <rect class="fragment hl"
                          data-fragment-index="2"
                          x="73%" y="35%"
                          rx="10px" ry="10px"
                          width="20%" height="18%"/>
                    <path class="fragment"
                          data-fragment-index="3"
                          marker-end='url(#head)'
                          stroke-width='8'
                          fill='none' stroke='red'
                          d="M65 350 l0 -100 l50 0"
                    />
                    <path class="fragment"
                          data-fragment-index="3"
                          marker-end='url(#head)'
                          stroke-width='8'
                          fill='none' stroke='red'
                          d="M430 350 l0 -100 l-50 0"
                    />
                </svg>
            </section>
            <section
                    data-background-image="cache-ram.png"
                    data-background-size="300px"
                    data-background-position="top right">
                <h2>Static RAM</h2>
                <ul>
                    <li>6 transistors per bit</li>
                    <li>Requires constant power</li>
                    <li>Logic-level</li>
                    <li>Repeating layout</li>
                    <li>&lt;1ns access times</li>
                    <li class="fragment">Why not make all RAM this way?<br>
                        <h2 class="fragment"
                            style="text-align: center; color: darkred;">COST!</h2></li>
                </ul>
            </section>
        </section>
        <section>
            <section>
                <!-- TODO more work here -->
                <h2>1 Bit of Dynamic RAM</h2>
                <img src="dynamic-ram.png" width="784px">
            </section>
            <section
                    data-background-image="dynamic-ram-sheep.png"
                    data-background-size="400px"
                    data-background-position="bottom right">
                <h2>Dynamic RAM</h2>
                <ul>
                    <li>One transistor per bit</li>
                    <li>Leaks charge
                        <ul>
                            <li>Requires refresh</li>
                        </ul>
                    </li>
                    <li>It's analogue!
                        <ul>
                            <li>Needs ADC</li>
                            <li>Takes time to charge/dischard</li>
                        </ul>
                    </li>
                    <li>External chips</li>
                </ul>
            </section>
            <section>
                <!-- TODO highlight areas -->
                <img src="ram-bank.png" class="stretch"/>
            </section>
            <section>
                <h2>Reading from DRAM (short version)</h2>
                <ul>
                    <li class="fragment">Precharge bit-lines (<code>t<sub>RP</sub></code> ~18 cycles)</li>
                    <li class="fragment">Select row (<code>t<sub>RCD</sub></code> ~18 cycles)</li>
                    <li class="fragment">Sense &amp; latch row data (~8192 bits)
                        <ul>
                            <li>Feedback starts recharging cells</li>
                        </ul>
                    </li>
                    <li class="fragment">Select column (<code>CAS</code> ~16 cycles)
                        <ul>
                            <li>Data is now available</li>
                        </ul>
                    </li>
                    <li class="fragment">Need to wait for next precharge (t<sub>RAS</sub> ~36 memory cycles)</li>
                </ul>
            </section>
            <section>
                <h2>DRAM timings &mdash; read</h2>
                <img src="ram-timings.1.png" class="stretch"/>
                <div class="attribution">
                    Image source: <a href="https://lwn.net/Articles/250967/">Ulrich Drepper</a>
                </div>
            </section>
            <section>
                <h2>DRAM timings &mdash; precharge</h2>
                <img src="ram-timings.2.png" class="stretch"/>
                <div class="attribution">
                    Image source: <a href="https://lwn.net/Articles/250967/">Ulrich Drepper</a>
                </div>
            </section>
            <section
                    data-background-image="NUMA-node-controller.png"
                    data-background-size="300px"
                    data-background-position="top right">
                <h2>Memory Controller</h2>
                <ul>
                    <li>Embedded in CPU</li>
                    <li>Opens/closes rows</li>
                    <li>Reorders load/stores</li>
                    <li>Schedules refreshes (~64ms)</li>
                    <li>Handles DMA</li>
                </ul>
                <div class="attribution">
                    Image source: <a href="https://lwn.net/Articles/250967/">Ulrich Drepper</a>
                </div>
            </section>
            <section>
                <h2>Getting DRAM data out</h2>
                <ul>
                    <li>DDR4 3200 bus runs at ~1600MHz</li>
                    <li>64-bits per clock, 2x pumped</li>
                    <li>1600MHz x 2 x 64 bit<br>
                        = 25,600MB/sec
                    </li>
                </ul>
            </section>
            <section>
                <h2>Access times</h2>
                <ul>
                    <li>First word: 10.67ns</li>
                    <li>Fourth word: 11.67ns</li>
                    <li>Eighth word: 13.00ns</li>
                </ul>
                <h2 class="fragment" style="text-align: center; color: darkred;">Access times can dominate over data
                    rates</h2>
            </section>
        </section>
    </div>
</div>

<script src="reveal.js/lib/js/head.min.js"></script>
<script src="reveal.js/js/reveal.js"></script>

<script>
    Reveal.initialize({
        history: true,
        transition: 'false',
        slideNumber: true,
        width: 1280,
        height: 720,
        dependencies: [
            {src: 'reveal.js/plugin/markdown/marked.js'},
            {src: 'reveal.js/plugin/markdown/markdown.js'},
            {src: 'reveal.js/plugin/notes/notes.js', async: true},
            {
                src: 'reveal.js/plugin/highlight/highlight.js', async: true, callback: function () {
                    hljs.initHighlightingOnLoad();
                }
            }
        ]
    });
</script>
</body>
</html>
